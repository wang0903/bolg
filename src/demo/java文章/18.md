---
icon: pen-to-square
date: 2026-02-06
category:
  - java
tag:
  - mysql
  - xxljob
star: true
sticky: true #标记
---
# 删除日志

## Java调用存储过程

### 接口

```java
/**
     * 删除 API 访问日志
     *
     */
    void deleteApiAccessLog();
```

### 实现(xxljob实现定时任务)

```java
   //引入数据库操作工具
   private final JdbcTemplate jdbcTemplate;

    public ApiAccessLogServiceImpl(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }
   //调存储过程
   @Override
    @XxlJob("deleteApiAccessLog")
    public void deleteApiAccessLog() {
        jdbcTemplate.update("CALL sp_maintain_month_partition(?,?,?)",
                "infra_api_access_log",
                "create_time",
                2);
    }
```

## MySQL层面

### 存储过程

```sql
DELIMITER $$

CREATE PROCEDURE sp_maintain_month_partition(
    IN p_table_name VARCHAR(64),   -- 表名
    IN p_date_col   VARCHAR(64),   -- 分区字段，如 create_time
    IN p_keep_month INT             -- 保留最近几个月分区
)
proc: BEGIN
    DECLARE v_next_month VARCHAR(6);
    DECLARE v_drop_month VARCHAR(6);
    DECLARE v_partition VARCHAR(64);
    DECLARE done INT DEFAULT 0;

    DECLARE cur CURSOR FOR
        SELECT PARTITION_NAME
        FROM information_schema.PARTITIONS
        WHERE TABLE_SCHEMA = DATABASE()
          AND TABLE_NAME = p_table_name
          AND PARTITION_NAME LIKE 'p%'
          AND PARTITION_NAME NOT LIKE 'pmax'
          AND PARTITION_NAME < CONCAT('p', DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL p_keep_month MONTH), '%Y%m'))
        ORDER BY PARTITION_NAME;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

    -- 防并发
    IF GET_LOCK(CONCAT('lock_partition_', p_table_name), 1) = 0 THEN
        LEAVE proc;
    END IF;

    -- =========================
    -- 一、创建下个月分区
    -- =========================
    SET v_next_month = DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL 1 MONTH), '%Y%m');

    -- 判断下个月分区是否存在
    SELECT COUNT(*) INTO @exists
    FROM information_schema.PARTITIONS
    WHERE TABLE_SCHEMA = DATABASE()
      AND TABLE_NAME = p_table_name
      AND PARTITION_NAME = CONCAT('p', v_next_month);

    IF @exists = 0 THEN
        SET @sql = CONCAT(
            'ALTER TABLE ', p_table_name,
            ' REORGANIZE PARTITION pmax INTO (',
            'PARTITION p', v_next_month,
            ' VALUES LESS THAN (TO_DAYS(''',
            DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL 2 MONTH), '%Y-%m-01'),
            ''')), PARTITION pmax VALUES LESS THAN MAXVALUE)'
        );
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
    END IF;

    -- =========================
    -- 二、删除过期分区
    -- =========================
    OPEN cur;
    read_loop: LOOP
        FETCH cur INTO v_partition;
        IF done = 1 THEN
            LEAVE read_loop;
        END IF;

        SET @sql = CONCAT('ALTER TABLE ', p_table_name, ' DROP PARTITION ', v_partition);
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
    END LOOP;
    CLOSE cur;

    -- =========================
    -- 三、释放锁
    -- =========================
    DO RELEASE_LOCK(CONCAT('lock_partition_', p_table_name));

END$$

DELIMITER ;
```

### 创建表分区

```sql
-- 创建新表
CREATE TABLE quality_module_atl_api_log_p
LIKE quality_module_atl_api_log;

-- 创建索引

ALTER TABLE quality_module_atl_api_log_p
DROP PRIMARY KEY,
ADD PRIMARY KEY (id, create_time);

-- 查看主键
SHOW CREATE TABLE quality_module_atl_api_log_p;

-- 创建分区
ALTER TABLE quality_module_atl_api_log_p
PARTITION BY RANGE (TO_DAYS(create_time)) (
    PARTITION p202512 VALUES LESS THAN (TO_DAYS('2026-01-01')),
    PARTITION p202601 VALUES LESS THAN (TO_DAYS('2026-02-01')),
    PARTITION p202602 VALUES LESS THAN (TO_DAYS('2026-03-01')),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);

-- 查看分区
SELECT PARTITION_NAME
FROM information_schema.PARTITIONS
WHERE TABLE_NAME = 'quality_module_atl_api_log_p';

-- 插入数据
INSERT INTO quality_module_atl_api_log
SELECT * FROM quality_module_atl_api_log_p;


-- 根据时间插入
INSERT INTO quality_module_atl_api_log
SELECT *
FROM quality_module_atl_api_log_p
WHERE create_time >= '2026-02-01'
  AND create_time <  '2026-03-01';
```

