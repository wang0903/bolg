import{_ as a}from"./plugin-vue_export-helper-x3n3nnut.js";import{o as s,c as n,a as e}from"./app-HMLpIP8o.js";const p={},l=e(`<h1 id="xtrabackup备份mysql数据库" tabindex="-1"><a class="header-anchor" href="#xtrabackup备份mysql数据库" aria-hidden="true">#</a> xtrabackup备份MySQL数据库</h1><h2 id="_1、备份脚本-backup-sh" tabindex="-1"><a class="header-anchor" href="#_1、备份脚本-backup-sh" aria-hidden="true">#</a> 1、备份脚本 <code>backup.sh</code></h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token comment"># 设置 MySQL 密码环境变量</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">MYSQL_PWD</span><span class="token operator">=</span><span class="token number">123456</span>
<span class="token comment"># 生成时间戳</span>
<span class="token assign-left variable">TIMESTAMP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +%Y%m%d%H%M%S<span class="token variable">)</span></span>

<span class="token comment"># 设置文件权限,数据库挂载出来的数据文件</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 设置 MySQL 数据目录下文件权限为 640...&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>
<span class="token function">find</span> /root/mysql/data <span class="token parameter variable">-type</span> f <span class="token parameter variable">-exec</span> <span class="token function">chmod</span> <span class="token number">755</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\\</span><span class="token punctuation">;</span>

<span class="token comment"># 设置目录权限</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 设置 MySQL 数据目录下目录权限为 750...&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>
<span class="token function">find</span> /root/mysql/data <span class="token parameter variable">-type</span> d <span class="token parameter variable">-exec</span> <span class="token function">chmod</span> <span class="token number">755</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\\</span><span class="token punctuation">;</span>
<span class="token comment"># 备份目录</span>
<span class="token assign-left variable">BACKUP_DIR</span><span class="token operator">=</span><span class="token string">&quot;/root/backup/full_backup_<span class="token variable">$TIMESTAMP</span>&quot;</span>

<span class="token comment"># 日志文件</span>
<span class="token assign-left variable">LOG_FILE</span><span class="token operator">=</span><span class="token string">&quot;/root/backup/backup_log_<span class="token variable">$TIMESTAMP</span>.log&quot;</span>

<span class="token comment"># 创建备份目录</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">$BACKUP_DIR</span>

<span class="token comment"># 确保备份目录权限正确</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> root:root <span class="token variable">$BACKUP_DIR</span>
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">777</span> <span class="token variable">$BACKUP_DIR</span>

<span class="token comment"># 日志记录：开始备份</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 开始备份...&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>

<span class="token comment"># 为 MySQL binlog 文件添加权限</span>
<span class="token comment"># 启动备份前，确保当前 binlog 文件的权限</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">log</span> <span class="token keyword">in</span> /root/mysql/data/binlog.*<span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 为 <span class="token variable">$log</span> 设置权限...&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>
    <span class="token function">chmod</span> <span class="token number">640</span> <span class="token string">&quot;<span class="token variable">$log</span>&quot;</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 执行备份命令...&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>
<span class="token comment"># 执行备份  --skip-log-bin加这一行是过滤掉日志文件</span>
<span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token punctuation">\\</span>
    <span class="token parameter variable">--network</span> mysql_default <span class="token punctuation">\\</span>
    <span class="token parameter variable">-v</span> /root/mysql/data/:/var/lib/mysql:ro <span class="token punctuation">\\</span>
    <span class="token parameter variable">-v</span> /root/backup:/backup <span class="token punctuation">\\</span>
    <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_PWD</span><span class="token operator">=</span><span class="token variable">$MYSQL_PWD</span> <span class="token punctuation">\\</span>
    percona/percona-xtrabackup:8.0 <span class="token punctuation">\\</span>
    xtrabackup <span class="token parameter variable">--user</span><span class="token operator">=</span>root <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token variable">$MYSQL_PWD</span> <span class="token parameter variable">--backup</span> --target-dir<span class="token operator">=</span>/backup/full_backup_<span class="token variable">$TIMESTAMP</span> <span class="token parameter variable">--datadir</span><span class="token operator">=</span>/var/lib/mysql <span class="token parameter variable">--host</span><span class="token operator">=</span><span class="token number">192.168</span>.200.234 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">3306</span> --skip-log-bin

<span class="token comment"># 备份完成后再次检查并修改 binlog 权限</span>
<span class="token function">find</span> /root/mysql/data/ <span class="token parameter variable">-name</span> <span class="token string">&quot;binlog*&quot;</span> <span class="token parameter variable">-exec</span> <span class="token function">chmod</span> <span class="token number">640</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\\</span><span class="token punctuation">;</span>


<span class="token comment"># 检查备份是否成功</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
   <span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 备份成功: <span class="token variable">$BACKUP_DIR</span>&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;备份成功: <span class="token variable">$BACKUP_DIR</span>&quot;</span>
<span class="token keyword">else</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 备份失败&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>
    <span class="token builtin class-name">echo</span> <span class="token string">&quot;备份失败&quot;</span>
<span class="token keyword">fi</span>
<span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 备份过程结束&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>
<span class="token comment"># 清理 7 天前的备份（可选）</span>
<span class="token function">find</span> /root/backup/full_backup_* <span class="token parameter variable">-mtime</span> +7 <span class="token parameter variable">-exec</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\\</span><span class="token punctuation">;</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 已清理 7 天前的备份&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>

<span class="token function">find</span> /root/backup/ <span class="token parameter variable">-name</span> <span class="token string">&quot;backup_log_*&quot;</span> <span class="token parameter variable">-mtime</span> +7 <span class="token parameter variable">-exec</span> <span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\\</span><span class="token punctuation">;</span>

<span class="token builtin class-name">echo</span> <span class="token string">&quot;[<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token variable">)</span></span>] 已清理 7 天前的日志&quot;</span> <span class="token operator">&gt;&gt;</span> <span class="token variable">$LOG_FILE</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2、给脚本运行权限" tabindex="-1"><a class="header-anchor" href="#_2、给脚本运行权限" aria-hidden="true">#</a> 2、给脚本运行权限</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">sudo</span> <span class="token function">chmod</span> +x backup.sh
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="_3、-编写恢复备份脚本" tabindex="-1"><a class="header-anchor" href="#_3、-编写恢复备份脚本" aria-hidden="true">#</a> 3、 编写恢复备份脚本</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 假设你的 MySQL 数据目录为 /var/lib/mysql</span>
<span class="token function">rsync</span> <span class="token parameter variable">-av</span> /root/backup/full_backup_<span class="token variable">$TIMESTAMP</span>/ /var/lib/mysql/

<span class="token comment"># 修改权限</span>
<span class="token function">chown</span> <span class="token parameter variable">-R</span> mysql:mysql /var/lib/mysql
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">750</span> /var/lib/mysql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4、-设置计划任务" tabindex="-1"><a class="header-anchor" href="#_4、-设置计划任务" aria-hidden="true">#</a> 4、 设置计划任务</h2><p>用宿主机设置计划任务，如果要用容器需要自己制作一个容器，这种比较麻烦，修改都需要重新重启容器和修改容器配置</p><p>使用 <code>cron</code> 设置计划任务，以每天的上午 8 点和下午 8 点执行备份脚本：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">crontab</span> <span class="token parameter variable">-e</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>在 <code>crontab</code> 文件中添加以下行：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">0</span> <span class="token number">8,20</span> * * * /backup.sh <span class="token operator">&gt;&gt;</span> /backups/backup.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="_5-启动容器并验证" tabindex="-1"><a class="header-anchor" href="#_5-启动容器并验证" aria-hidden="true">#</a> 5. 启动容器并验证</h3><p>重新启动容器，并手动运行恢复备份脚本来验证备份和恢复功能：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">docker-compose</span> restart xtrabackup
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> xtrabackup /restore.sh <span class="token comment">#需要恢复时在运行</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>确保恢复备份后，您需要手动启动 MySQL 服务-</p>`,17),t=[l];function i(c,o){return s(),n("div",null,t)}const k=a(p,[["render",i],["__file","10.html.vue"]]);export{k as default};
